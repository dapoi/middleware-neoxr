<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Config</title>
  <link rel="stylesheet" href="app-config.css">
</head>
<body>
  <div class="card">
    <h1>App Configuration</h1>
    <div class="subtitle">Easily enable/disable features and update your app version.</div>
    <div class="toggle-group">
      <span class="toggle-label">
        <span class="icon-wrapper">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke="#4f8cff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="17" width="16" height="4" rx="2" fill="#eaf3ff"/></svg>
        </span>
        Downloader Feature
      </span>
      <label class="switch">
        <input type="checkbox" id="downloaderToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="toggle-group">
      <span class="toggle-label">
        <span class="icon-wrapper">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="#eaf3ff" stroke="#4f8cff" stroke-width="2"/><circle cx="8" cy="10" r="2" fill="#4f8cff"/><path d="M21 19l-5.5-7-4.5 6-3-4L3 19" stroke="#4f8cff" stroke-width="2" stroke-linecap="round"/></svg>
        </span>
        Image Generator Feature
      </span>
      <label class="switch">
        <input type="checkbox" id="imageGenToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="toggle-group version-row">
      <span class="toggle-label">
        <span class="icon-wrapper">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="3" fill="#eaf3ff" stroke="#4f8cff" stroke-width="2"/><path d="M8 8h8v2H8z" fill="#4f8cff"/><rect x="8" y="12" width="8" height="2" rx="1" fill="#4f8cff"/></svg>
        </span>
        App Version
      </span>
      <div class="version-actions">
        <input type="text" id="appVersionInput" class="version-input" />
        <button id="saveVersionBtn" disabled class="save-btn">Save</button>
      </div>
    </div>
  </div>
  <script>
    let currentVersion = '';
    function updateSaveButtonState() {
      const input = document.getElementById('appVersionInput');
      const btn = document.getElementById('saveVersionBtn');
      const val = input.value.trim();
      if (!val || val === currentVersion) {
        btn.disabled = true;
        btn.style.opacity = 0.6;
        btn.style.cursor = 'not-allowed';
      } else {
        btn.disabled = false;
        btn.style.opacity = 1;
        btn.style.cursor = 'pointer';
      }
    }

    async function fetchConfig() {
      try {
        console.log('Fetching config from /api/app-config...');
        const res = await fetch('/api/app-config');
        console.log('Response status:', res.status);
        const data = await res.json();
        console.log('Config data received:', data);
        
        document.getElementById('downloaderToggle').checked = data.isDownloaderFeatureActive;
        document.getElementById('imageGenToggle').checked = data.isImageGeneratorFeatureActive;
        document.getElementById('appVersionInput').value = data.version || '';
        currentVersion = data.version || '';
        updateSaveButtonState();
        console.log('Config loaded successfully');
      } catch (error) {
        console.error('Error fetching config:', error);
      }
    }

    function showToast(message) {
      let toast = document.getElementById('modernToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'modernToast';
        toast.className = 'toast';
        document.body.appendChild(toast);
      }
      toast.innerHTML = `<span style="color:#3bbf5c;display:inline-flex;align-items:center;"><svg width='20' height='20' viewBox='0 0 24 24' fill='none'><circle cx='12' cy='12' r='12' fill='#eafbe7'/><path d='M8 12.5l2.5 2.5L16 9' stroke='#3bbf5c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg></span> ${message}`;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 1600);
    }

    async function updateConfig(sendVersion = false) {
      try {
        console.log('Updating config, sendVersion:', sendVersion);
        const body = {
          isDownloaderFeatureActive: document.getElementById('downloaderToggle').checked,
          isImageGeneratorFeatureActive: document.getElementById('imageGenToggle').checked
        };
        if (sendVersion) {
          body.version = document.getElementById('appVersionInput').value.trim() || currentVersion;
        }
        console.log('Sending data:', body);
        
        const response = await fetch('/api/app-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        console.log('Update response status:', response.status);
        const result = await response.json();
        console.log('Update result:', result);
        
        if (sendVersion) {
          currentVersion = body.version;
          document.getElementById('appVersionInput').value = currentVersion;
          updateSaveButtonState();
          showToast('Version saved!');
        }
      } catch (error) {
        console.error('Error updating config:', error);
      }
    }

    document.getElementById('downloaderToggle').addEventListener('change', () => updateConfig(false));
    document.getElementById('imageGenToggle').addEventListener('change', () => updateConfig(false));
    document.getElementById('saveVersionBtn').addEventListener('click', () => updateConfig(true));
    document.getElementById('appVersionInput').addEventListener('input', updateSaveButtonState);
    
    // Wait for DOM to be ready, then fetch config
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, fetching initial config...');
      fetchConfig();
    });
  </script>
</body>
</html>